generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION MODELS
// ============================================

model User {
  id               String      @id
  name             String
  email            String      @unique
  emailVerified    Boolean     @default(false)
  image            String?
  role             String      @default("user")
  phones           Phone[]
  profileCompleted Boolean     @default(false)
  sessions         Session[]
  accounts         Account[]
  inflow           Inflow[]
  sale             Sale[]
  outflow          Outflow[]
  userStore        UserStore[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  withdraws        Withdraw[]
  movements        Movement[]

  @@index([email])
  @@index([role])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId, providerId])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// ============================================
// BUSINESS MODELS
// ============================================

model Phone {
  id        String   @id @default(cuid())
  number    String
  isPrimary Boolean  @default(false)
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([number])
}

model Store {
  id                  String      @id @default(cuid())
  name                String      @unique
  warehouses          Warehouse[]
  salesAreas          SalesArea[]
  providedInflows     Inflow[]
  destinationOutflows Outflow[]
  userStores          UserStore[]
  products            Product[]
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([name])
}

model UserStore {
  userId    String
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@id([userId, storeId])
  @@index([userId])
  @@index([storeId])
}

model Warehouse {
  id                   String               @id @default(cuid())
  name                 String
  storeId              String
  inflows              Inflow[]
  outflows             Outflow[]
  warehouseInventories WarehouseInventory[]
  destinationMovements Movement[]
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Restrict)

  @@unique([name, storeId])
  @@index([storeId])
}

model SalesArea {
  id                   String               @id @default(cuid())
  name                 String
  storeId              String
  outflows             Outflow[]
  sales                Sale[]
  withdraws            Withdraw[]
  salesAreaInventories SalesAreaInventory[]
  sourceMovements      Movement[]
  destinationMovements Movement[]          @relation("DestinationSalesAreaMovement")
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Restrict)

  @@unique([name, storeId])
  @@index([storeId])
}

model GeneralCategory {
  id          String     @id
  name        String     @unique
  description String?
  categories  Category[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([name])
}

model Category {
  id                String    @id
  generalCategoryId String
  name              String
  description       String?
  products          Product[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  generalCategory GeneralCategory @relation(fields: [generalCategoryId], references: [id], onDelete: Restrict)

  @@index([generalCategoryId])
  @@index([name])
}

model Product {
  id         String  @id
  storeId    String
  categoryId String
  name       String
  costPrice  Decimal @db.Decimal(18, 6)
  salePrice  Decimal @db.Decimal(18, 2)
  unit       String

  inflow             Inflow[]
  sale               Sale[]
  outflow            Outflow[]
  warehouseInventory WarehouseInventory[]
  salesAreaInventory SalesAreaInventory[]
  movements          Movement[]
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([categoryId])
  @@index([name])
}

model Company {
  id              String   @id @default(cuid())
  name            String   @unique
  providedInflows Inflow[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([name])
}

// ============================================
// INVENTORY MODELS
// ============================================

model WarehouseInventory {
  id          String   @id @default(cuid())
  warehouseId String
  productId   String
  quantity    Decimal  @default(0) @db.Decimal(18, 2)
  minStock    Decimal? @default(0) @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
  @@index([quantity])
}

model SalesAreaInventory {
  id          String   @id @default(cuid())
  salesAreaId String
  productId   String
  quantity    Decimal  @default(0) @db.Decimal(18, 2)
  minStock    Decimal? @default(0) @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  salesArea SalesArea @relation(fields: [salesAreaId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([salesAreaId, productId])
  @@index([salesAreaId])
  @@index([productId])
  @@index([quantity])
}

// ============================================
// TRANSACTION MODELS
// ============================================

model Inflow {
  id                String   @id @default(cuid())
  userId            String
  warehouseId       String
  date              DateTime @default(now()) @db.Date
  inType            String
  providerCompanyId String?
  providerStoreId   String?
  payMethod         String?
  invoiceNumber     String?
  inNumber          String
  productId         String
  quantity          Decimal  @default(0) @db.Decimal(18, 2)
  costAmount        Decimal  @db.Decimal(18, 2)
  saleAmount        Decimal  @db.Decimal(18, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
  providerCompany Company?  @relation(fields: [providerCompanyId], references: [id], onDelete: SetNull)
  providerStore   Store?    @relation(fields: [providerStoreId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([warehouseId])
  @@index([productId])
  @@index([providerCompanyId])
  @@index([providerStoreId])
  @@index([date])
  @@index([inType])
}

model Outflow {
  id                     String   @id @default(cuid())
  userId                 String
  warehouseId            String
  date                   DateTime @default(now()) @db.Date
  outType                String
  destinationStoreId     String?
  destinationSalesAreaId String?
  payMethod              String?
  outNumber              String
  productId              String
  quantity               Decimal  @default(0) @db.Decimal(18, 2)
  saleAmount             Decimal  @db.Decimal(18, 2)
  costAmount             Decimal  @db.Decimal(18, 2)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user                 User       @relation(fields: [userId], references: [id], onDelete: Restrict)
  warehouse            Warehouse  @relation(fields: [warehouseId], references: [id])
  product              Product    @relation(fields: [productId], references: [id], onDelete: Restrict)
  destinationStore     Store?     @relation(fields: [destinationStoreId], references: [id], onDelete: SetNull)
  destinationSalesArea SalesArea? @relation(fields: [destinationSalesAreaId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([warehouseId])
  @@index([productId])
  @@index([destinationStoreId])
  @@index([destinationSalesAreaId])
  @@index([date])
  @@index([outType])
}

model Sale {
  id          String   @id @default(cuid())
  userId      String
  salesAreaId String
  date        DateTime @default(now()) @db.Date
  payMethod   String
  productId   String
  quantity    Decimal  @default(0) @db.Decimal(18, 2)
  saleAmount  Decimal  @db.Decimal(18, 2)
  costAmount  Decimal  @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  salesArea SalesArea @relation(fields: [salesAreaId], references: [id], onDelete: Restrict)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([salesAreaId])
  @@index([productId])
  @@index([date])
  @@index([payMethod])
}

model Withdraw {
  id          String   @id @default(cuid())
  userId      String
  salesAreaId String
  date        DateTime @default(now()) @db.Date
  amount      Decimal  @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  salesArea SalesArea @relation(fields: [salesAreaId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([salesAreaId])
  @@index([date])
}

model Movement {
  id                String   @id @default(cuid())
  userId            String
  movementType      String // DEVOLUCION, TRASLADO
  date              DateTime @default(now()) @db.Date
  movementNumber    String
  sourceSalesAreaId String
  destinationWarehouseId  String?
  destinationSalesAreaId  String?
  productId         String
  quantity          Decimal  @default(0) @db.Decimal(18, 2)
  costAmount        Decimal  @db.Decimal(18, 2)
  saleAmount        Decimal  @db.Decimal(18, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user                User       @relation(fields: [userId], references: [id], onDelete: Restrict)
  sourceSalesArea     SalesArea  @relation(fields: [sourceSalesAreaId], references: [id], onDelete: Restrict)
  destinationWarehouse Warehouse? @relation(fields: [destinationWarehouseId], references: [id], onDelete: SetNull)
  destinationSalesArea SalesArea? @relation("DestinationSalesAreaMovement", fields: [destinationSalesAreaId], references: [id], onDelete: SetNull)
  product             Product    @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([movementType])
  @@index([sourceSalesAreaId])
  @@index([destinationWarehouseId])
  @@index([destinationSalesAreaId])
  @@index([productId])
  @@index([date])
}
